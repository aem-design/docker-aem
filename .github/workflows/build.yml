name: build

on: [push]

jobs:
  build:
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    runs-on: ubuntu-latest
    env:
      DOCKER_REGISTRY: docker.io
      DOCKER_REGISTRY_INDEX: index.docker.io/aemdesign
      ORGANISATION_NAME: aemdesign
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      GOOGLE_DRIVEID_AEM: ${{ secrets.GOOGLE_DRIVEID_SDK_2022_4_7138 }}
      GOOGLE_DRIVEID_AEM_VERSION: "2022.4.7138.20220427T075748Z-220401"
      CREDS_ADOBE: ${{ secrets.CREDS_ADOBE }}
      PACKAGE_PATH: "./packages"
      JAR_PATH: "./jar"
      PYTHON_VERSION: 3.6


    steps:
      - name: Experimental Status
        run: |
          docker version -f '{{.Server.Experimental}}'
      - name: Docker
        run: |
          docker version -f '{{.Server.Experimental}}'
          export DOCKER_CLI_EXPERIMENTAL=enabled
          docker version -f '{{.Server.Experimental}}'
          sudo service docker restart
          docker version -f '{{.Server.Experimental}}'
          sudo rm /etc/docker/daemon.json
          echo $'{\n    "experimental": true\n}' | sudo tee /etc/docker/daemon.json
          sudo service docker restart
          docker version -f '{{.Server.Experimental}}'
      - uses: actions/checkout@v2
      - name: set up python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v1
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      - name: install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: set envirnment variables and get packages
        id: config
        run: |
          echo GET PACKAGES
          export PACKAGE_PATH=$(pwd)/packages
          echo "PACKAGE_PATH=${PACKAGE_PATH}" >> $GITHUB_ENV
          source <(curl -sL https://github.com/aem-design/aemdesign-docker/releases/latest/download/github_get_config.sh)
          source <(curl -sL https://github.com/aem-design/aemdesign-docker/releases/latest/download/download-gdrive.sh)
          echo $PACKAGE_PATH
          echo $JAR_PATH
          if [[ ! -d $PACKAGE_PATH ]]; then mkdir $PACKAGE_PATH; fi
          if [[ ! -d $JAR_PATH ]]; then mkdir $JAR_PATH; fi
          echo PACKAGES CONTENTS $PACKAGE_PATH
          ls -latr $PACKAGE_PATH
          echo DOWNLOAD JAR INTO ${JAR_PATH}
          downloadGDrive "download" "$GOOGLE_DRIVEID_AEM" "$JAR_PATH/aem-quickstart.jar"
          echo DOWNLOAD PACKAGES INTO ${PACKAGE_PATH}
          # ============================================
          # PACKAGE INSTALL
          # ============================================
          export PACKAGE_CKECK_COUNT=0
          # --------------------------------------------
          #downloadGDrive "download" "${GOOGLE_DRIVEID_AEM_FORMS}" "$PACKAGE_PATH/01-aem-forms-addon-2021.03.19.02.far"
          # ./scripts/download.sh "$PACKAGE_PATH/02-" "-" "githublatest:.*core.wcm.components.all.*.zip" "https://api.github.com/repos/adobe/aem-core-wcm-components/releases/latest"
          # ./scripts/download.sh "$PACKAGE_PATH/03-" "-" "githublatest:.*acs-aem-commons-content-[0-9\.]+.zip" "https://api.github.com/repos/Adobe-Consulting-Services/acs-aem-commons/releases/latest"
          # ./scripts/download.sh "$PACKAGE_PATH/04-" "-" "-" "https://repo1.maven.org/maven2/biz/netcentric/cq/tools/accesscontroltool/accesscontroltool-package/3.0.2/accesscontroltool-package-3.0.2-cloud.zip"
          # ./scripts/download.sh "$PACKAGE_PATH/05-" "-" "-" "https://repo1.maven.org/maven2/biz/netcentric/cq/tools/accesscontroltool/accesscontroltool-oakindex-package/3.0.2/accesscontroltool-oakindex-package-3.0.2-cloud.zip"
          # ./scripts/download.sh "$PACKAGE_PATH/06-" "-" "githublatest:.*aemdesign-aem-core-deploy.*.zip" "https://api.github.com/repos/aem-design/aemdesign-aem-core/releases/latest"
          # ./scripts/download.sh "$PACKAGE_PATH/07-" "-" "githublatest:.*aemdesign-aem-support-deploy.*.zip" "https://api.github.com/repos/aem-design/aemdesign-aem-support/releases/latest"
          # --------------------------------------------
          echo "PACKAGE_CKECK_COUNT=${PACKAGE_CKECK_COUNT}" >> $GITHUB_ENV
          echo ::set-output name=PACKAGE_CKECK_COUNT::$PACKAGE_CKECK_COUNT
          echo PACKAGE COUNT=$PACKAGE_CKECK_COUNT
          ls -latr $PACKAGE_PATH
          source <(curl -sL https://github.com/aem-design/aemdesign-docker/releases/latest/download/github_get_version.sh)

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and export to Docker
        uses: docker/build-push-action@v2
        with:
          context: .
          platforms: linux/arm64
          load: true
          build-args: |
            "JDK_DRIVEID=${{ env.JDK_DRIVEID }}"
          tags: |
            ${{ env.IMAGE }}:${{ env.GIT_BRANCH }}
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE }}:${{ env.GIT_BRANCH }}


      - name: test docker image
        run: |
          cd test && bash ./run_tests.sh "ghcr.io/$GITHUB_REPOSITORY_OWNER/$IMAGE:$GIT_BRANCH"

      - name: Build and push
        uses: docker/build-push-action@v2
        with:
          context: .
          platforms: linux/arm64
          push: true
          build-args: |
            "JDK_DRIVEID=${{ env.JDK_DRIVEID }}"
          tags: |
            ${{ env.IMAGE }}:${{ env.GIT_BRANCH }}
            ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE }}:${{ env.GIT_BRANCH }}

      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v2
        continue-on-error: true
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}
          repository: peterevans/dockerhub-description
      - uses: meeDamian/github-release@1.0
        if: github.ref == 'refs/heads/master'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.GITHUB_TAG }}
          name: ${{ env.GITHUB_TAG }}
          body: ${{ env.GIT_RELEASE_NOTES }}
